<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tómbola Virtual con Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        .container {
            text-align: center;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
        }
        input {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 10px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        ul {
            list-style-type: none;
            padding: 0;
            margin-top: 20px;
        }
        li {
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .credits {
            margin-top: 20px;
            font-size: 12px;
            color: #555;
        }
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
        }
        .confirm-dialog button {
            margin: 5px;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirm-dialog .accept-button {
            background-color: #28a745;
            color: white;
        }
        .confirm-dialog .reject-button {
            background-color: #dc3545;
            color: white;
        }
        .admin-controls {
            display: none;
            margin-top: 20px;
        }
        .admin-controls button {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tómbola Virtual</h1>
        <input type="text" id="nameInput" placeholder="Ingresa un nombre">
        <input type="text" id="paymentInput" placeholder="Escribe si pagó (Sí/No)" style="display: none;">
        <button onclick="addName()">Agregar Nombre</button>

        <h3>Lista de Nombres (Máximo 5 para participantes).</h3>
        <ul id="nameList"></ul>

        <h3>Ganador:</h3>
        <p id="winner"></p>

        <div class="admin-controls" id="adminControls">
            <input type="password" id="adminPassword" placeholder="Contraseña">
            <button onclick="authenticateAdmin()">Aceptar</button>
            <button id="drawButton" onclick="drawWinner()">Sacar Ganador</button>
            <button id="updateButton" onclick="showUpdateDialog()">Actualizar</button>
        </div>

        <div class="credits">
            <p>Solamente tienen acceso estudiantes Normalistas del 10° E.</p>
            <p>Página Creada por TheGringo (Allan).</p>
        </div>
    </div>

    <div class="admin-controls">
        <button onclick="enableAdminMode()">Entrar al Modo Admin</button>
        <button onclick="disableAdminMode()">Salir del Modo Admin</button>
    </div>

    <!-- Diálogo de confirmación para actualización -->
    <div class="confirm-dialog" id="confirmDialog">
        <p>¿Estás seguro de que deseas eliminar todos los nombres?</p>
        <button class="accept-button" onclick="updateList()">Aceptar</button>
        <button class="reject-button" onclick="closeUpdateDialog()">Cancelar</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCw4UaU2rGJ0xKa_VOWPaCdYtEAWks00Wg",
            authDomain: "tombola-virtual-b468f.firebaseapp.com",
            projectId: "tombola-virtual-b468f",
            storageBucket: "tombola-virtual-b468f.appspot.com",
            messagingSenderId: "910212105790",
            appId: "1:910212105790:web:a8ecb8fa66632f2b75f36f",
            measurementId: "G-TGX002B4JF"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
    </script>

    <script>
        let names = [];
        let adminMode = false;
        const adminPassword = "Admin_Adaya123.Araúz"; // Contraseña para el administrador

        // Inicializa la lista de nombres desde Firebase
        async function initializeNames() {
            const querySnapshot = await getDocs(collection(db, 'names'));
            names = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateNameList();
        }

        function addName() {
            const nameInput = document.getElementById('nameInput');
            const paymentInput = document.getElementById('paymentInput');
            const name = nameInput.value.trim();
            const payment = paymentInput.value.trim().toLowerCase();

            if (name === '') {
                alert("Por favor, ingresa un nombre.");
                return;
            }
            
            if (!adminMode && names.length >= 5) {
                alert("Solo puedes agregar un máximo de 5 nombres.");
                return;
            }
            
            if (adminMode && payment !== '' && payment !== 'sí' && payment !== 'no') {
                alert("Por favor, ingresa 'Sí' o 'No' en el campo de pago.");
                return;
            }

            const newName = { name, paid: adminMode ? payment === 'sí' : false };
            
            if (adminMode) {
                addDoc(collection(db, 'names'), newName);
            } else {
                if (names.length < 5) {
                    addDoc(collection(db, 'names'), newName);
                } else {
                    alert("Solo puedes agregar un máximo de 5 nombres.");
                }
            }

            names.push(newName);
            updateNameList();
            nameInput.value = '';
            paymentInput.value = '';
        }

        function updateNameList() {
            const nameList = document.getElementById('nameList');
            nameList.innerHTML = '';
            names.forEach((entry, index) => {
                const li = document.createElement('li');
                li.textContent = entry.name;
                li.className = entry.paid ? 'paid' : 'not-paid';
                li.onclick = () => showPaymentOptions(index);
                nameList.appendChild(li);
            });
        }

        function showPaymentOptions(index) {
            if (!adminMode) return;
            const li = document.querySelectorAll('li')[index];
            const adminOption = document.getElementById('adminOptions');

            if (adminOption) {
                adminOption.style.top = `${li.offsetTop + li.offsetHeight}px`;
                adminOption.style.left = `${li.offsetLeft}px`;
                adminOption.style.display = 'block';

                // Store the index of the selected item in adminOptions
                adminOption.dataset.index = index;
            }
        }

        function updatePaymentStatus(paid) {
            const index = document.getElementById('adminOptions').dataset.index;
            if (index !== undefined) {
                names[index].paid = paid;
                updateNameList();
                document.getElementById('adminOptions').style.display = 'none';

                // Update in Firebase
                const nameId = names[index].id;
                setDoc(doc(db, 'names', nameId), { ...names[index], paid });
            }
        }

        function enableAdminMode() {
            document.getElementById('adminControls').style.display = 'block';
            document.getElementById('paymentInput').style.display = 'block';
            adminMode = true;
            alert("Modo Admin activado. Ahora puedes agregar más nombres y gestionar pagos.");
        }

        function disableAdminMode() {
            document.getElementById('adminControls').style.display = 'none';
            document.getElementById('paymentInput').style.display = 'none';
            adminMode = false;
            alert("Modo Admin desactivado. Solo puedes agregar hasta 5 nombres.");
        }

        function authenticateAdmin() {
            const passwordInput = document.getElementById('adminPassword').value;
            if (passwordInput === adminPassword) {
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('updateButton').style.display = 'block';
                document.getElementById('adminOptions').style.display = 'none'; // Oculta las opciones si están visibles
                alert("Inicio de sesión exitoso. Ahora puedes sacar un ganador y agregar más nombres.");
            } else {
                alert("Contraseña incorrecta. No tienes permiso para sacar un ganador.");
            }
        }

        function drawWinner() {
            if (names.length === 0) {
                alert("No hay nombres en la lista.");
                return;
            }

            const winnerElement = document.getElementById('winner');
            const randomIndex = Math.floor(Math.random() * names.length);
            const winner = names[randomIndex].name;

            // Animación de selección de ganador
            let animationIndex = 0;
            const interval = setInterval(() => {
                const randomAnimationIndex = Math.floor(Math.random() * names.length);
                winnerElement.textContent = names[randomAnimationIndex].name;
                animationIndex++;
                if (animationIndex >= 30) { // Cambia de nombre 30 veces
                    clearInterval(interval);
                    winnerElement.textContent = `¡El ganador es: ${winner}!`;
                }
            }, 100);
        }

        function showUpdateDialog() {
            document.getElementById('confirmDialog').style.display = 'block';
        }

        function closeUpdateDialog() {
            document.getElementById('confirmDialog').style.display = 'none';
        }

        async function updateList() {
            const namesCollection = collection(db, 'names');
            const querySnapshot = await getDocs(namesCollection);
            querySnapshot.forEach(async (doc) => {
                await deleteDoc(doc.ref);
            });
            names = [];
            updateNameList();
            document.getElementById('confirmDialog').style.display = 'none';
        }

        // Inicializa los datos cuando la página carga
        window.onload = initializeNames;
    </script>
</body>
</html>
